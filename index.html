<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play Forge V41 - Full Engine</title>
    <style>
        :root { --dark-0: #050505; --dark-1: #0f0f0f; --dark-2: #181818; --accent: #00ffff; --text: #ddd; --border: #333; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark-0); color: var(--text); overflow: hidden; touch-action: none; }

        #editor-ui { display: flex; height: 100vh; flex-direction: column; }
        .toolbar { height: 50px; background: var(--dark-1); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; gap: 8px; z-index: 100; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar { width: 300px; background: var(--dark-1); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-header { background: var(--dark-2); padding: 12px; font-size: 10px; font-weight: 900; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        
        #viewport { flex: 1; position: relative; background: #000; outline: none; }
        
        .list-item { padding: 12px; border-bottom: 1px solid #222; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: #1a1a1a; }
        .list-item.sel { background: #102a2a; border-left: 4px solid var(--accent); }
        .btn { background: #252525; border: 1px solid var(--border); color: #fff; padding: 8px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold; }
        .btn:active { transform: scale(0.95); }

        #create-menu { position: absolute; left: 10px; top: 10px; background: var(--dark-2); border: 1px solid var(--border); border-radius: 4px; display: none; flex-direction: column; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .menu-opt { padding: 14px 20px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #333; }
        .menu-opt:hover { background: var(--accent); color: #000; }
        
        #joy-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(0,255,255,0.03); border: 2px solid rgba(0,255,255,0.1); border-radius: 50%; display: none; z-index: 2000; }
        #joy-knob { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 20px var(--accent); pointer-events: none; }
        #btn-jump { position: absolute; bottom: 60px; right: 40px; width: 75px; height: 75px; background: rgba(0,255,255,0.1); border: 2px solid var(--accent); border-radius: 50%; display: none; justify-content: center; align-items: center; font-weight: bold; color: var(--accent); z-index: 2000; }

        label { display: block; margin-top: 15px; font-size: 9px; color: #888; text-transform: uppercase; font-weight: 800; }
        input, select, textarea { background: #000; border: 1px solid var(--border); color: #fff; width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; font-size: 12px; }
        .script-card { background: #111; border: 1px solid #444; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .script-card textarea { height: 120px; font-family: 'Courier New', monospace; font-size: 11px; color: #00ffaa; border-color: #222; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

<div id="editor-ui">
    <div class="toolbar">
        <button class="btn" onclick="setGizmo('translate')">MOVER</button>
        <button class="btn" onclick="setGizmo('rotate')">GIRAR</button>
        <button class="btn" onclick="setGizmo('scale')">ESCALA</button>
        <div style="flex:1"></div>
        <button class="btn" id="btn-fs">TELA CHEIA</button>
        <button class="btn" id="btn-play" style="background:#004444; color:var(--accent); border-color:var(--accent)">PLAY</button>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="panel-header">Hierarchy <span onclick="toggleMenu()" style="color:var(--accent); cursor:pointer; font-size:16px">+</span></div>
            <div id="obj-list" class="scroll-area"></div>
        </div>

        <div id="viewport">
            <div id="create-menu">
                <div class="menu-opt" onclick="spawn('box')">ðŸ“¦ Bloco</div>
                <div class="menu-opt" onclick="spawn('sphere')">âš½ Esfera</div>
                <div class="menu-opt" onclick="spawn('player')">ðŸ‘¤ Player</div>
                <div class="menu-opt" onclick="triggerImport()" style="color:var(--accent)">ðŸ“¥ Importar GLB</div>
            </div>
            
            <input type="file" id="file-glb" hidden accept=".glb,.gltf">
            <input type="file" id="file-tex" hidden accept="image/*">
            
            <div id="joy-zone"><div id="joy-knob"></div></div>
            <div id="btn-jump">PULAR</div>
        </div>

        <div class="sidebar">
            <div class="panel-header">Inspector</div>
            <div id="inspector-panel" class="scroll-area" style="display:none">
                <label>Nome do Objeto</label>
                <input type="text" id="i-name">
                
                <label>Cor do Material</label>
                <input type="color" id="i-color">
                
                <label>Textura</label>
                <button class="btn" onclick="triggerTex()" style="width:100%; margin-top:5px; background:#111">SELECIONAR IMAGEM</button>
                
                <label>FÃ­sica</label>
                <select id="i-phys">
                    <option value="none">PassÃ¡vel</option>
                    <option value="fixed">SÃ³lido (ColisÃ£o)</option>
                </select>

                <div id="player-only" style="display:none">
                    <label>VisÃ£o</label>
                    <select id="i-cam">
                        <option value="1st">Primeira Pessoa</option>
                        <option value="3rd">Terceira Pessoa</option>
                    </select>
                </div>

                <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
                
                <label>Scripts Ativos</label>
                <button class="btn" onclick="addScript()" style="width:100%; background:#002222; color:var(--accent)">+ ADICIONAR SCRIPT</button>
                <div id="scripts-container" style="margin-top:10px"></div>

                <button class="btn" id="btn-del" style="width:100%; margin-top:30px; color:#ff4444; border-color:#ff4444; background: rgba(255,0,0,0.05)">DELETAR OBJETO</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let scene, camera, renderer, controls, gizmo, loader;
    let objects = [], selected = null, isPlaying = false;
    let moveF = 0, moveS = 0, vy = 0, yaw = 0, pitch = 0;
    let lookTouchId = null, lastX, lastY;

    init();

    function init() {
        const container = document.getElementById('viewport');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);

        camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 1000);
        camera.position.set(10, 10, 10);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(5, 20, 10);
        scene.add(sun);

        scene.add(new THREE.GridHelper(100, 100, 0x00ffff, 0x002222));

        controls = new OrbitControls(camera, renderer.domElement);
        gizmo = new TransformControls(camera, renderer.domElement);
        gizmo.addEventListener('dragging-changed', e => controls.enabled = !e.value);
        scene.add(gizmo);

        loader = new GLTFLoader();

        // Globals
        window.spawn = spawn;
        window.toggleMenu = () => { const m = document.getElementById('create-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; };
        window.setGizmo = (mode) => gizmo.setMode(mode);
        window.triggerImport = () => document.getElementById('file-glb').click();
        window.triggerTex = () => document.getElementById('file-tex').click();
        window.addScript = addScript;

        setupEvents();
        loop();
    }

    function spawn(type, data = null) {
        let mesh;
        const defaultMat = new THREE.MeshStandardMaterial({ color: 0x0088ff });

        if(type === 'box') mesh = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), defaultMat);
        else if(type === 'sphere') mesh = new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32), defaultMat);
        else if(type === 'player') mesh = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 1), new THREE.MeshStandardMaterial({color: 0x00ff00}));
        else if(type === 'glb') mesh = data;

        mesh.position.set(0, 1, 0);
        const obj = { 
            id: Date.now(), 
            name: type + "_" + objects.length, 
            type, 
            mesh, 
            phys: 'none', 
            cam: '1st', 
            scripts: [] 
        };

        scene.add(mesh);
        objects.push(obj);
        refreshHierarchy();
        select(obj);
        document.getElementById('create-menu').style.display = 'none';
    }

    function select(obj) {
        selected = obj;
        if(obj && !isPlaying) gizmo.attach(obj.mesh); else gizmo.detach();
        
        const panel = document.getElementById('inspector-panel');
        panel.style.display = obj ? 'block' : 'none';
        
        if(obj) {
            document.getElementById('i-name').value = obj.name;
            document.getElementById('i-phys').value = obj.phys;
            document.getElementById('player-only').style.display = obj.type === 'player' ? 'block' : 'none';
            
            // Sincronizar Cor no Input
            if(obj.mesh.material && obj.mesh.material.color) {
                document.getElementById('i-color').value = "#" + obj.mesh.material.color.getHexString();
            }
            renderScripts();
        }
    }

    function addScript() {
        if(!selected) return;
        selected.scripts.push({ name: 'Script_' + selected.scripts.length, code: 'this.rotation.y += 0.02;' });
        renderScripts();
    }

    function renderScripts() {
        const container = document.getElementById('scripts-container');
        container.innerHTML = '';
        if(!selected) return;

        selected.scripts.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = 'script-card';
            
            const inp = document.createElement('input');
            inp.value = s.name;
            inp.oninput = (e) => s.name = e.target.value;

            const txt = document.createElement('textarea');
            txt.value = s.code;
            txt.oninput = (e) => s.code = e.target.value;

            const del = document.createElement('button');
            del.className = 'btn';
            del.style.cssText = "width:100%; color:red; margin-top:8px; background:rgba(255,0,0,0.1)";
            del.innerText = "REMOVER SCRIPT";
            del.onclick = () => {
                selected.scripts.splice(i, 1);
                renderScripts();
            };

            card.append(inp, txt, del);
            container.appendChild(card);
        });
    }

    function setupEvents() {
        // Fullscreen
        document.getElementById('btn-fs').onclick = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        };

        // Play/Stop
        document.getElementById('btn-play').onclick = () => {
            isPlaying = !isPlaying;
            document.getElementById('btn-play').innerText = isPlaying ? "STOP" : "PLAY";
            document.getElementById('joy-zone').style.display = isPlaying ? "block" : "none";
            document.getElementById('btn-jump').style.display = isPlaying ? "flex" : "none";
            controls.enabled = !isPlaying;
            gizmo.detach();

            if(isPlaying) {
                objects.forEach(o => {
                    o.oldPos = o.mesh.position.clone();
                    o.oldRot = o.mesh.rotation.clone();
                    o.runtimeScripts = o.scripts.map(s => {
                        try { return new Function(s.code).bind(o.mesh); }
                        catch(e) { return null; }
                    });
                });
            } else {
                objects.forEach(o => {
                    if(o.oldPos) o.mesh.position.copy(o.oldPos);
                    if(o.oldRot) o.mesh.rotation.copy(o.oldRot);
                });
                yaw = 0; pitch = 0; moveF = 0; moveS = 0;
            }
        };

        // Cor do Objeto (AplicaÃ§Ã£o Direta)
        document.getElementById('i-color').oninput = (e) => {
            if(selected && selected.mesh.material) {
                selected.mesh.material.color.set(e.target.value);
            }
        };

        // Textura do Objeto (AplicaÃ§Ã£o Direta)
        document.getElementById('file-tex').onchange = (e) => {
            const file = e.target.files[0];
            if(file && selected) {
                const url = URL.createObjectURL(file);
                new THREE.TextureLoader().load(url, (tex) => {
                    selected.mesh.material.map = tex;
                    selected.mesh.material.needsUpdate = true;
                });
            }
        };

        // Joystick Logic
        const jz = document.getElementById('joy-zone'), jk = document.getElementById('joy-knob');
        jz.addEventListener('touchstart', e => {
            const r = jz.getBoundingClientRect(), cx = r.left + 60, cy = r.top + 60;
            const move = ev => {
                const t = [...ev.touches].find(t => t.clientX < window.innerWidth/2);
                if(!t) return;
                const dx = t.clientX - cx, dy = t.clientY - cy, d = Math.min(Math.sqrt(dx*dx+dy*dy), 40), a = Math.atan2(dy, dx);
                jk.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                moveS = Math.cos(a) * (d/40); moveF = -Math.sin(a) * (d/40);
            };
            const end = () => { moveF = 0; moveS = 0; jk.style.transform = ''; window.removeEventListener('touchmove', move); };
            window.addEventListener('touchmove', move); window.addEventListener('touchend', end);
        });

        // Touch Look
        const vp = document.getElementById('viewport');
        vp.addEventListener('touchstart', e => {
            if(!isPlaying) return;
            const t = [...e.changedTouches].find(t => t.clientX > window.innerWidth/2);
            if(t) { lookTouchId = t.identifier; lastX = t.clientX; lastY = t.clientY; }
        });
        vp.addEventListener('touchmove', e => {
            if(!isPlaying || lookTouchId === null) return;
            const t = [...e.changedTouches].find(t => t.identifier === lookTouchId);
            if(t) {
                yaw -= (t.clientX - lastX) * 0.005;
                pitch -= (t.clientY - lastY) * 0.005;
                pitch = Math.max(-1.5, Math.min(1.5, pitch));
                lastX = t.clientX; lastY = t.clientY;
            }
        });

        document.getElementById('i-name').oninput = e => { if(selected) { selected.name = e.target.value; refreshHierarchy(); } };
        document.getElementById('i-phys').onchange = e => { if(selected) selected.phys = e.target.value; };
        document.getElementById('i-cam').onchange = e => { if(selected) selected.cam = e.target.value; };
        document.getElementById('btn-del').onclick = () => { if(selected) { scene.remove(selected.mesh); objects = objects.filter(o => o !== selected); select(null); refreshHierarchy(); } };
        
        document.getElementById('file-glb').onchange = e => {
            const f = e.target.files[0];
            if(f) loader.load(URL.createObjectURL(f), g => spawn('glb', g.scene));
        };
        document.getElementById('btn-jump').onclick = () => { if(vy === 0) vy = 0.25; };
    }

    function loop() {
        requestAnimationFrame(loop);
        if(isPlaying) {
            objects.forEach(o => {
                if(o.runtimeScripts) o.runtimeScripts.forEach(fn => { if(fn) fn(); });
                
                if(o.type === 'player') {
                    vy -= 0.012; o.mesh.position.y += vy;
                    if(o.mesh.position.y < 0.5) { o.mesh.position.y = 0.5; vy = 0; }
                    
                    const dirF = new THREE.Vector3();
                    camera.getWorldDirection(dirF); dirF.y = 0; dirF.normalize();
                    const dirS = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dirF).normalize();
                    o.mesh.position.add(new THREE.Vector3().addScaledVector(dirF, moveF * 0.15).addScaledVector(dirS, -moveS * 0.15));

                    if(o.cam === '1st') {
                        camera.position.copy(o.mesh.position); camera.position.y += 0.4;
                        camera.rotation.set(pitch, yaw + Math.PI, 0, 'YXZ');
                    } else {
                        const d = 5;
                        camera.position.set(o.mesh.position.x + Math.sin(yaw)*d, o.mesh.position.y + 2.5, o.mesh.position.z + Math.cos(yaw)*d);
                        camera.lookAt(o.mesh.position);
                    }
                }
            });
        }
        renderer.render(scene, camera);
    }

    function refreshHierarchy() {
        const list = document.getElementById('obj-list'); list.innerHTML = '';
        objects.forEach(o => {
            const div = document.createElement('div');
            div.className = `list-item ${selected === o ? 'sel' : ''}`;
            div.innerText = o.name;
            div.onclick = () => select(o);
            list.appendChild(div);
        });
    }
</script>
</body>
</html>
